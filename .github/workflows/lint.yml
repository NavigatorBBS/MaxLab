name: Linting

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  powershell-lint:
    name: PowerShell Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $scriptFiles = @(Get-ChildItem -Path . -Include *.ps1 -Recurse -Exclude .github | Select-Object -ExpandProperty FullName)
          if ($scriptFiles.Count -gt 0) {
            $allResults = @()
            foreach ($file in $scriptFiles) {
              $results = Invoke-ScriptAnalyzer -Path $file -Severity Warning
              if ($results) {
                $allResults += $results
              }
            }
            if ($allResults) {
              Write-Error "PSScriptAnalyzer found issues:`n$($allResults | Format-List | Out-String)"
              exit 1
            }
          }

  python-lint:
    name: Python Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run flake8
        run: |
          # Lint Python files in src and workspace directories
          flake8 src/ workspace/ --count --select=E9,F63,F7,F82 --show-source --statistics || exit 0
          flake8 src/ workspace/ --count --exit-code=1 --max-line-length=120 --statistics

  notebook-outputs:
    name: Check Notebook Outputs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install nbstripout
        run: |
          python -m pip install --upgrade pip
          pip install nbstripout

      - name: Check notebook outputs
        run: |
          # Check that notebooks have no outputs (would be modified by nbstripout)
          nbstripout --dry-run workspace/notebooks/*.ipynb
